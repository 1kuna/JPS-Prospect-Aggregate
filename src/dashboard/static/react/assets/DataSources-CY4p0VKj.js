import{u as i,c as z,d as B,e as G,r as o,j as t,A as H,a as X,b as q,B as S,D as J,g as Q,h as V,i as W,k as Y,l as Z,f as ee,S as se}from"./index-D-hIGNao.js";import{P as $,D as te}from"./DataTable-rxEv2n-l.js";const ae=s=>s.dataSources,re=s=>s.loading.dataSources,oe=s=>s.errors.dataSources,ce=s=>s.fetchDataSources,ne=s=>s.createDataSource,le=s=>s.updateDataSource,ie=s=>s.pullDataSource,ue=s=>s.getScraperStatus,de=s=>s.pullingProgress,ge=s=>s.setPullingProgress;function pe(){const s=i(ae),D=i(re),x=i(oe),u=i(ce),b=i(ne),T=i(le),N=i(ie),h=i(ue),v=i(de),n=i(ge),{toast:d}=z(),{addToast:A}=B(),{addToast:k}=G(),[w,f]=o.useState(!1),[g,C]=o.useState(null),[p,m]=o.useState(!0);o.useEffect(()=>(console.log("DataSources component mounted, fetching data sources..."),u().then(()=>{console.log("Data sources fetched successfully in component"),m(!1)}).catch(e=>{console.error("Error fetching data sources in component:",e),m(!1)}),()=>{console.log("DataSources component unmounting")}),[u]),o.useEffect(()=>{if(!s.length)return;const e=s.filter(r=>v[r.id]);if(e.length===0)return;console.log("Found running data sources:",e);const a=[],c={},l=3*60*1e3;return e.forEach(r=>{c[r.id]=Date.now();const P=setInterval(async()=>{try{const y=Date.now()-c[r.id];if(y>l){clearInterval(P);const I=`Scraper timed out after ${Math.floor(y/6e4)} minutes. The operation may still be running in the background.`;d({title:"Scraper Timeout",description:I,variant:"destructive",duration:15e3}),await u(),n(r.id,!1);return}const j=await h(String(r.id));if(console.log(`Status check for source ID ${r.id}:`,j),j.status!=="running"){if(clearInterval(P),j.status==="success"){const I=`Successfully pulled data from ${r.name}`;d({title:"Success!",description:I,variant:"success",duration:1e4})}else d({title:"Error pulling data",description:j.message,variant:"destructive",duration:15e3});await u(),n(r.id,!1)}}catch(y){console.error("Error checking scraper status:",y)}},1e3);a.push(P)}),()=>{a.forEach(r=>clearInterval(r))}},[s,v,h,u,d,n]),o.useEffect(()=>{console.log("DataSources component state:",{dataSources:s,loading:D,errors:x,isInitialLoad:p})},[s,D,x,p]);const M=o.useCallback(()=>{console.log("Manually refreshing data sources..."),m(!0),u().then(()=>{console.log("Data sources refreshed successfully"),m(!1)}).catch(e=>{console.error("Error refreshing data sources:",e),m(!1)})},[u]),L=o.useCallback(async e=>{try{await b(e),f(!1)}catch(a){console.error("Failed to create data source:",a)}},[b]),F=o.useCallback(async e=>{try{await T(String(e.id),e),f(!1),C(null)}catch(a){console.error("Failed to update data source:",a)}},[T]),K=o.useCallback(e=>{C(e),f(!0)},[]),R=o.useCallback(async()=>{if(!(!s||s.length===0))for(const e of s)try{const a=await h(String(e.id));console.log(`Initial status check for source ID ${e.id}:`,a),a.status==="running"&&(n(e.id,!0),E(e))}catch(a){console.error(`Error checking status for source ID ${e.id}:`,a)}},[s,h,n]),E=o.useCallback(e=>{let a=setInterval(async()=>{try{const c=await h(String(e.id));if(console.log(`Status check for source ID ${e.id}:`,c),c.status!=="running"){if(clearInterval(a),c.status==="completed"){const l=`Successfully pulled data from ${e.name}`;d({title:"Success!",description:l,variant:"success",duration:1e4})}else(c.status==="timeout"||c.status==="failed")&&d({title:"Error pulling data",description:c.message,variant:"destructive",duration:15e3});n(e.id,!1),u()}}catch(c){console.error("Error checking scraper status:",c),clearInterval(a),n(e.id,!1)}},2e3);return a},[h,n,d,u]);o.useEffect(()=>{R()},[R]);const U=o.useCallback(async e=>{var a,c;try{n(e.id,!0);const l=`Starting to pull data from ${e.name}. This may take a while...`;A({title:"Pulling data",description:l,variant:"default",duration:0}),k({title:"Pulling data",message:l,type:"info"}),console.log(`Starting to pull data from source ID ${e.id}: ${e.name}`);const r=await N(String(e.id));console.log(`Pull initiated for source ID ${e.id}:`,r),E(e)}catch(l){console.error("Failed to pull data source:",l);const r=((c=(a=l.response)==null?void 0:a.data)==null?void 0:c.message)||l.message||"An unknown error occurred";d({title:"Error pulling data",description:r,variant:"destructive",duration:15e3}),k({title:"Error pulling data",message:r,type:"error",duration:15e3}),n(e.id,!1)}},[N,E,d,A,k,n]),O=o.useCallback(()=>{f(!1),C(null)},[]);if((p||D)&&!s.length)return t.jsx($,{title:"Data Sources",isLoading:!0,children:t.jsx("div",{children:"Loading data sources..."})});if(x&&!p&&!s.length)return t.jsxs("div",{className:"space-y-6",children:[t.jsx("h1",{className:"text-3xl font-bold tracking-tight",children:"Data Sources"}),t.jsxs(H,{variant:"destructive",children:[t.jsx(X,{children:"Error loading data sources"}),t.jsx(q,{children:x.message})]}),t.jsx(S,{onClick:M,children:"Retry"})]});const _=[{header:"Name",accessorKey:"name"},{header:"URL",accessorKey:"url"},{header:"Status",accessorKey:"status"},{header:"Last Checked",accessorKey:e=>e.lastChecked?ee(e.lastChecked):"Never"},{header:"Proposals",accessorKey:e=>{var a;return((a=e.proposalCount)==null?void 0:a.toString())||"0"}},{header:"Actions",accessorKey:"id",cell:e=>t.jsxs("div",{className:"flex space-x-2",children:[t.jsx(S,{variant:"outline",size:"sm",onClick:()=>U(e),disabled:v[e.id],children:v[e.id]?t.jsxs("span",{className:"flex items-center",children:[t.jsx(se,{className:"mr-2 h-4 w-4"}),"Pulling..."]}):"Pull Source"}),t.jsx(S,{variant:"outline",size:"sm",onClick:()=>K(e),children:"Edit"})]})}];return t.jsx($,{title:"Data Sources",children:t.jsxs("div",{className:"space-y-4",children:[t.jsxs("div",{className:"flex justify-between items-center",children:[t.jsxs("p",{className:"text-muted-foreground",children:[s.length," data sources configured"]}),t.jsxs("div",{className:"flex gap-2",children:[t.jsx(S,{onClick:M,children:"Refresh"}),t.jsxs(J,{open:w,onOpenChange:f,children:[t.jsx(Q,{asChild:!0,children:t.jsx(S,{children:"Add Data Source"})}),t.jsxs(V,{children:[t.jsx(W,{children:t.jsx(Y,{children:g?"Edit Data Source":"Add Data Source"})}),t.jsx(Z,{initialData:g?{id:g.id,name:g.name,url:g.url,description:g.description}:void 0,onSubmit:e=>{g?F({...e,id:g.id}):L(e)},onCancel:O})]})]})]})]}),t.jsx(te,{data:s,columns:_,emptyMessage:"No data sources configured",isLoading:D||p})]})})}export{pe as default};
